<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Solr sparse faceting : Fast high cardinality faceting for small result sets">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Solr sparse faceting</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/tokee/lucene-solr">View on GitHub</a>

          <h1 id="project_title">Solr sparse faceting</h1>
          <h2 id="project_tagline">Fast high cardinality faceting for small result sets</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/tokee/lucene-solr/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/tokee/lucene-solr/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a name="sparse-faceting-for-solr" class="anchor" href="#sparse-faceting-for-solr"><span class="octicon octicon-link"></span></a>Sparse faceting for Solr</h2>

<p>This project is for the <a href="https://issues.apache.org/jira/browse/SOLR-5894">SOLR-5894</a> patch.</p>

<h3>
<a name="elevator-pitch" class="anchor" href="#elevator-pitch"><span class="octicon octicon-link"></span></a>Elevator pitch</h3>

<p>Sparse faceting speeds up the majority of Solr searches that uses faceting on large (1.000.000+ unique terms) text fields, such as <em>author</em> or <em>title</em>. The speed-up is extremely dependent on the setup, but expect at least a factor 2 for single-shard indexes and more for multi-shard.</p>

<h3>
<a name="download-and-usage" class="anchor" href="#download-and-usage"><span class="octicon octicon-link"></span></a>Download and usage</h3>

<p>Download a sparse WAR and use it instead of the standard Solr WAR. No tweaks are needed to solrconfig.xml.</p>

<ul>
<li><a href="https://github.com/tokee/lucene-solr/releases/">Solr 4.8 &amp; 4.9 sparse WAR</a></li>
</ul><h3>
<a name="sample-calls" class="anchor" href="#sample-calls"><span class="octicon octicon-link"></span></a>Sample calls</h3>

<ul>
<li>
<a href="http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield">http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield</a><br>
A standard faceting call, which should trigger sparse faceting if the number of unique values is 10.000+ in mytextfield. Note that <code>facet.method</code> must be <code>fc</code> for sparse to work. However, Solr uses <code>fc</code> per default for large text fields, so there is probably no need to state it explicitly.</li>
<li>
<a href="http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;facet.sparse=false">http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;<strong>facet.sparse=false</strong></a><br>
When sparse faceting is disabled, faceting is handled by the standard Solr faceting implementation. Useful for checking correctness and performance differences.</li>
<li>
<a href="http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;facet.sparse.stats=true">http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;<strong>facet.sparse.stats=true</strong></a><br>
An ugly hack that provides statistics on sparse faceting by returning it as part of the facet result. Only intended for experimenting, but very useful to determine if sparse is activated at all.</li>
<li>
<a href="http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;facet.sparse.skiprefinements=true">http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;<strong>facet.sparse.skiprefinements=true</strong></a><br>
In a multi-shard setup this speeds up faceting at the cost of precision, by skipping the fine-counting of facets. The reported counts will be &lt;= the true counts. Use it if response time is paramount.</li>
<li>
<a href="http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;facet.sparse.maxtracked=255">http://localhost:8983/solr/collection1/select?wt=xml&amp;q=myquery&amp;facet.field=mytextfield&amp;<strong>facet.sparse.maxtracked=255</strong></a><br>
Maxtracked sets an upper limit for the counts in the facets in the shards (the total count in a distributed setting might be higher). This might speed things up a bit (the values 15, 255 &amp; 65535 are good for this) and lowers the memory requirement for faceting. Use it if memory usage is paramount.</li>
</ul><p>See <a href="https://github.com/tokee/lucene-solr/blob/lucene_solr_4_8_sparse/solr/core/src/java/org/apache/solr/request/sparse/SparseKeys.java">SparseKeys.java</a> for a detailed description of the knobs to tweak.</p>

<h2>
<a name="how-well-does-this-work" class="anchor" href="#how-well-does-this-work"><span class="octicon octicon-link"></span></a>How well does this work?</h2>

<p>When we enabled sparse faceting for our core index (50GB / 14M docs / 2 large, 6 small facets) at the State and University Library, Denmark, we observed that our response times during work hours were halved, compared to 7 days earlier:</p>

<p><img src="graphs/workhours_20140903-20140910.png" alt="Before and after enabling of sparse faceting at Statsbiblioteket"></p>

<p>For the Danish Web Archive (12TB / 4B docs / 1 massive, 3 large, 2 small facets), response times dropped to less than 1/5 when using sparse faceting:</p>

<p><img src="graphs/sparse_factor_60min_12.5TB_4.2B_solr_sparse_finecount_l10.png" alt="Solr fc faceting vs. sparse faceting at the Danish Web Archive"></p>

<p>See the links at the bottom for full reports on our observations.</p>

<h3>
<a name="is-this-reliable" class="anchor" href="#is-this-reliable"><span class="octicon octicon-link"></span></a>Is this reliable?</h3>

<p>We use it in production at <a href="http://statsbiblioteket.dk/">State and University Library, Denmark</a> with millions of unique values in the facets and at the <a href="http://netarkivet.dk/">Danish Web Archive</a> with billions of unique values in one of the facets. The patch does not change the index in any way, so the worst thing that can happen is that one needs to switch back to standard Solr.</p>

<h3>
<a name="the-sparse-principle" class="anchor" href="#the-sparse-principle"><span class="octicon octicon-link"></span></a>The sparse principle</h3>

<p>Standard Solr fc String faceting maintains an array of counters for all possible values in the facet. The counters are incremented based on the document IDs from the search and all counters are iterated to extract top-X, including the ones that have not been touched. Sparse faceting keeps track of which counters are incremented, so only those are iterated. For small result sets and fields with many unique values, the time-saving is substantial. Empirical measurements puts "small result sets" around 8% or less of the total document count and suggests that most user-issued searches are below this.</p>

<p>Standard Solr allocates facet counter structures when needed and frees them after use. This takes time upon allocation (think 10s of milliseconds) and taxes the garbage collector. Sparse faceting maintains a pool of counters and clears them using a background thread, meaning instant counter "allocation" and no taxing of the garbage collector.</p>

<p>Distributed faceting on a multi-shard Solr setup require fine-counting for some of the terms. Standard Solr handles this with a mini-search for each term, while sparse faceting uses full counting followed by extraction of counts for the specified terms. This turns out to be much faster. Think factor 10.</p>

<p>For a more in-depth description, see <a href="What%20is%20high%20cardinality%20anyway?">http://sbdevel.wordpress.com/2014/10/02/what-is-high-cardinality-anyway/</a></p>

<h3>
<a name="limitations" class="anchor" href="#limitations"><span class="octicon octicon-link"></span></a>Limitations</h3>

<p>Sparse faceting may not help with single-shard searches with large result sets (&gt; 8% of index size). Fortunately it does not hurt either as it falls back to the Solr standard way of counting: There are a lot of knobs to tune this, but the default are chosen conservatively, so the chance of having worse-than-standard response times should be quite low.</p>

<p>For multi-shard searches, sparse faceting should be faster for practically all setups and result set sizes, as long as the field uses DocValues. Similar speed up for non-DocValued fields is a question of coding time. See <a href="Add%20fast%20term%20lookup%20to%20non-DocValues%20faceting">Issue #15</a> for details and status.</p>

<p>The existence of a cache for the counter structures does result in a permanent memory overhead, as opposed to a variable one with standard Solr fc faceting. The size of the cache can be controlled, so it is possible to disable it fully, if this is a concern.</p>

<p>Currently only <code>facet.method=fc</code> is supported, for single- and multi-value, with and without DocValues. In theory the sparse principle can be applied to <code>facet.method=fcs</code>, although the gains will probably be somewhat smaller. This sub-project has not been started yet. See <a href="https://github.com/tokee/lucene-solr/issues/8">issue #8</a> for details.</p>

<h3>
<a name="why-is-this-not-in-standard-solr" class="anchor" href="#why-is-this-not-in-standard-solr"><span class="octicon octicon-link"></span></a>Why is this not in standard Solr?</h3>

<p>Basically because it needs a Solr committer to accept the patch. Visit <a href="https://issues.apache.org/jira/browse/SOLR-5894">SOLR-5894</a> and vote for it, if you want to encourage this.</p>

<p>It is not just a question of the committer pressing <em>accept</em> though. The patch needs to be tested independently and the committer should have some experience with the Solr faceting code, in order to ensure that SOLR-5894 plays nice with the rest of the code base.</p>

<h3>
<a name="nitty-gritty" class="anchor" href="#nitty-gritty"><span class="octicon octicon-link"></span></a>Nitty gritty</h3>

<p>Sparseness it not related to document count per se. It is all about the facet values.</p>

<p>Imagine an index with 40M documents and an <em>author</em> field. There are 10M unique authors and each document has 0-4 authors. Most searches hits 1,000 - 1,000,000 documents. This is a prime candidate for sparse faceting as most searches will result in less than 8% (3,200,000) of all unique names in the author facet being part of the search result. Nearly all searches will be processed as sparse. If all goes well, this will increase <code>withinCutoff</code> in the stats feedback.</p>

<p>100 authors are extremely popular and are each referenced by 100,000 documents. This is not a problem as it has little influence on the number of unique authors in the search result. See the <em>tag</em>-example below for the reverse case.</p>

<p>The index has a <em>subject</em> field with 100,000 unique values. Each document has 1-10 subjects. For this field, chances are a lot higher than a search will result in more than 8% (800) of the unique subjects being part of the search result. Only searches with very low hit count will be processed as sparse. This is not too problematic if sparse faceting guesses right and uses non-sparse counting got the searches that are estimated to exceed the 8% limit: In that case speed will be equivalent with standard Solr. This up front disabling of sparseness is counted in the <code>disables</code> in the stats feedback.</p>

<p>The index has a <em>tag</em> field with 100,000 unique values. Most documents have 1-10 tags, but every 1,000 document has 10,000 tags (the auto-tagger ran amok). It only takes a single amok-document to blow the sparse limit of 8% of the unique tags, so chances are high that it will be blown <strong>and</strong> that the sparseness guesser will estimate that it will not. This combination results in wasted work in the collector, so the sparse faceting will be worse than standard Solr. In the stats feedback, <code>exceededCutoff</code> is the number of times this has happened.</p>

<h3>
<a name="more-reading-and-tests" class="anchor" href="#more-reading-and-tests"><span class="octicon octicon-link"></span></a>More reading and tests</h3>

<ul>
<li><a href="https://sbdevel.wordpress.com/2014/06/17/terabyte-index-search-and-faceting-with-solr/">Terabyte index, search and faceting with Solr</a></li>
<li><a href="https://sbdevel.wordpress.com/2014/08/26/ten-times-faster/">Ten times faster</a></li>
<li><a href="https://sbdevel.wordpress.com/author/eskildsen/">Even sparse faceting is limited</a></li>
<li><a href="https://sbdevel.wordpress.com/2014/09/09/small-scale-sparse-faceting/">Small scale sparse faceting</a></li>
</ul><h3>
<a name="who-made-this" class="anchor" href="#who-made-this"><span class="octicon octicon-link"></span></a>Who made this?</h3>

<p>Sparse faceting is the work of Toke Eskildsen. Most of the code was implemented on company time at the State and University Library, Denmark. It was fueled partly by the need for snappy responses from the Danish Web Archive, partly because the gains are just too awesome to let pass. Many thanks to the State and University Library for supporting Open Source by allocating the time needed to make such things public.</p>

<p>Feel free to contact Toke Eskildsen, <a href="mailto:te@statsbiblioteket.dk">te@statsbiblioteket.dk</a>, <a href="https://twitter.com/TokeEskildsen">@TokeEskildsen</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Solr sparse faceting maintained by <a href="https://github.com/tokee">tokee</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
