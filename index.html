<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="description" content="Solr sparse faceting : Fast high cardinality faceting for small result sets">

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>Solr sparse faceting</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/tokee/lucene-solr">View on GitHub</a>

          <h1 id="project_title">Solr sparse faceting</h1>
          <h2 id="project_tagline">Fast high cardinality faceting for small result sets</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/tokee/lucene-solr/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/tokee/lucene-solr/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h2>
<a name="sparse-faceting-for-solr" class="anchor" href="#sparse-faceting-for-solr"><span class="octicon octicon-link"></span></a>Sparse faceting for Solr</h2>

<p>This project is for the <a href="https://issues.apache.org/jira/browse/SOLR-5894">SOLR-5894</a> patch.</p>

<h3>
<a name="elevator-pitch" class="anchor" href="#elevator-pitch"><span class="octicon octicon-link"></span></a>Elevator pitch</h3>

<p>Sparse faceting speeds up the majority of Solr searches that uses faceting on large (100.000+ unique terms) text fields, such as <em>author</em> or <em>title</em>. The speed-up is extremely dependent on the setup, but expect at least a factor 2 for single-shard indexes and more for multi-shard.</p>

<h3>
<a name="download-and-usage" class="anchor" href="#download-and-usage"><span class="octicon octicon-link"></span></a>Download and usage</h3>

<p>Simply download the Solr WAR and use that instead of the standard one. Or build the latest version from source (Solr 4.8 and 4.9 currently supported).</p>

<ul>
<li><a href="https://github.com/tokee/lucene-solr/releases/tag/sparse_4.8_20140912-alpha">Solr 4.8 sparse WAR</a></li>
</ul><p>See <a href="https://github.com/tokee/lucene-solr/blob/lucene_solr_4_8_sparse/solr/core/src/java/org/apache/solr/request/sparse/SparseKeys.java">SparseKeys.java</a> for the dials to tweak.</p>

<h3>
<a name="is-this-reliable" class="anchor" href="#is-this-reliable"><span class="octicon octicon-link"></span></a>Is this reliable?</h3>

<p>We use it in production at <a href="http://statsbiblioteket.dk/">State and University Library, Denmark</a> with millions of unique values in the facets and at the <a href="http://netarkivet.dk/">Danish Web Archive</a> with billions of unique values in on of the facets. The patch does not change the index in any way, so the worst thing that can happen is that one needs to switch back to standard Solr.</p>

<h3>
<a name="the-sparse-principle" class="anchor" href="#the-sparse-principle"><span class="octicon octicon-link"></span></a>The sparse principle</h3>

<p>Standard Solr fc String faceting maintains an array of counters for all possible values in the facet. The counters are updated based on the document IDs from the search and then iterated to extract top-X. Sparse faceting keeps track of which counters are updated, so only those are iterated. For fields with many unique values, the time-saving is substantial for small result sets. Empirical measurements puts "small" around 8% or less and suggests that most user-issued searches are below this.</p>

<p>Standard Solr allocates the counter structures when needed and frees them after use. This takes time upon allocation (think 10s of milliseconds) and taxes the garbage collector. Sparse faceting maintains a pool of counters and clears them using a background thread, meaning instant counter "allocation" and no taxing of the garbage collector.</p>

<p>Distributed faceting on a multi-shard Solr setup require fine-counting for some terms. Standard Solr handles this with a mini-search for each term, while sparse faceting uses full counting and extraction of counts for the specified terms. This turns out to be much faster. Think factor 10.</p>

<h3>
<a name="the-downside" class="anchor" href="#the-downside"><span class="octicon octicon-link"></span></a>The downside</h3>

<p>Sparse faceting does not help with single-shard searches with large result sets. Fortunately it does not hurt either as it falls back to the standard way of counting - there are a lot of knobs to tune this, but the default are chosen conservatively so the chance of having worse-than-standard response times is quite low. For multi-shard searches, sparse faceting should be faster for nearly all setups.</p>

<h3>
<a name="more-reading" class="anchor" href="#more-reading"><span class="octicon octicon-link"></span></a>More reading</h3>

<ul>
<li><a href="https://sbdevel.wordpress.com/2014/06/17/terabyte-index-search-and-faceting-with-solr/">Terabyte index, search and faceting with Solr</a></li>
<li><a href="https://sbdevel.wordpress.com/2014/08/26/ten-times-faster/">Ten times faster</a></li>
<li><a href="https://sbdevel.wordpress.com/author/eskildsen/">Even sparse faceting is limited</a></li>
<li><a href="https://sbdevel.wordpress.com/2014/09/09/small-scale-sparse-faceting/">Small scale sparse faceting</a></li>
</ul><h3>
<a name="why-is-this-not-in-standard-solr" class="anchor" href="#why-is-this-not-in-standard-solr"><span class="octicon octicon-link"></span></a>Why is this not in standard Solr?</h3>

<p>Basically because it needs a Solr committer to accept the patch. Visit <a href="https://issues.apache.org/jira/browse/SOLR-5894">SOLR-5894</a> and vote for it, if you want to encourage this.</p>

<p>It is not just a question of the committer pressing <em>accept</em> though. The patch needs to be tested independently and the committer should have some experience with the Solr faceting code, in order to ensure that SOLR-5894 plays nice with the rest of the code base.</p>

<h3>
<a name="who-made-this" class="anchor" href="#who-made-this"><span class="octicon octicon-link"></span></a>Who made this?</h3>

<p>Sparse faceting is the work of Toke Eskildsen. Most of the code was implemented on company time at the State and University Library, Denmark. It was fueled partly by the need for snappy responses from the Danish Web Archive, partly because the gains are just too awesome to let pass. Great thanks to the State and University Library for supporting Open Source by allocating the time needed to make such things public.</p>

<p>Feel free to contact Toke Eskildsen, <a href="mailto:te@statsbiblioteket.dk">te@statsbiblioteket.dk</a>, <a href="https://twitter.com/TokeEskildsen">@TokeEskildsen</a></p>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p class="copyright">Solr sparse faceting maintained by <a href="https://github.com/tokee">tokee</a></p>
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
