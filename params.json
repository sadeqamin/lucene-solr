{"name":"Solr sparse faceting","tagline":"Fast high cardinality faceting for small result sets","body":"## Sparse faceting for Solr\r\nThis project is for the [SOLR-5894](https://issues.apache.org/jira/browse/SOLR-5894) patch.\r\n\r\n### Elevator pitch\r\nSparse faceting speeds up the majority of Solr searches that uses faceting on large (> 100.000 unique terms) text fields, such as _author_ or _title_. The amount of speed-up is extremely dependent on the setup, but expect at least a factor 2 for single-shard indexes and more for multi-shard.\r\n\r\n### The sparse principle\r\nStandard Solr fc String faceting maintains an array of counters for all possible values in the facet. The counters are updated based on the document IDs from the search and the counters are iterated to extract top-X. Sparse faceting keeps track of which counters are updated, so only those are iterated. For fields with millions of unique values, the time-saving is substantial for small result sets. Empirical measurements puts \"small\" around 8% or less.\r\n\r\nStandard Solr allocates the counter structures when needed and frees them after use. This takes time upon allocation (think tens of milliseconds) and taxed the garbage collector. Sparse faceting maintains a pool of counters and clears them using a background thread, meaning instant counter \"allocation\" and no taxing of the garbage collector.\r\n\r\nFaceting with a multi-shard Solr setup require fine-counting of specific terms under the hood. Standard Solr handles this with a mini-search for each term, while sparse faceting uses full counting and extraction of counts for the specified terms. This turns out to be much (think factor 10) faster.\r\n\r\n### The downside\r\nSparse faceting does not help with single-shard searches with large result sets. Fortunately it does not hurt either as it falls back to the standard way of counting - there are a lot of knobs to tune this, but the default are chosen conservatively so the chance of having worse-than-standard response times is quite low. For multi-shard searches, sparse faceting should be faster for nearly all setups.\r\n\r\n### Is this reliable?\r\nWell, we use it in production at [Statsbiblioteket](http://statsbiblioteket.dk/) and at the [Danish Web Archive](http://netarkivet.dk/). From a test-methodological viewpoint, there is a profound need for independent installations before this can be called solid.\r\n\r\nSo please, hit the download-link (Solr 4.8 compatible) or build from source. Test it with your Solr installation! See [SparseKeys.java](https://github.com/tokee/lucene-solr/blob/lucene_solr_4_8_sparse/solr/core/src/java/org/apache/solr/request/sparse/SparseKeys.java) for the dials to tweak.\r\n\r\n### More reading\r\n* [Terabyte index, search and faceting with Solr](https://sbdevel.wordpress.com/2014/06/17/terabyte-index-search-and-faceting-with-solr/)\r\n* [Ten times faster](https://sbdevel.wordpress.com/2014/08/26/ten-times-faster/)\r\n* [Even sparse faceting is limited](https://sbdevel.wordpress.com/author/eskildsen/)\r\n* [Small scale sparse faceting](https://sbdevel.wordpress.com/2014/09/09/small-scale-sparse-faceting/)\r\n\r\n### Contact\r\n\r\nAny questions? Feel free to contact Toke Eskildsen, te@statsbiblioteket.dk","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}